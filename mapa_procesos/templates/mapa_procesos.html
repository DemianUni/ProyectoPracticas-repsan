{% extends 'base.html' %}

{% load static %}

{% block titulo %}
  Mapa de procesos
{% endblock %}

{% block contenido %}
  {% csrf_token %}
  {% load tz %} <!-- Esto carga los filtros relacionados con la zona horaria -->

  <link rel="stylesheet" href="{% static 'css/mapa_procesos.css' %}" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Signika+Negative&display=swap" rel="stylesheet" />

  <main>
    <h1 class="mb-4" style="font-size: 3.5rem; text-align: center; font-family: 'Signika Negative', sans-serif; font-style: italic;">MAPA DE PROCESOS</h1>
    <!-- Mapa Procesos -->
    <div id="svgContainer" style="display: flex; justify-content: center; align-items: center; width: 100%; margin: 0; padding: 0;">
      <object type="image/svg+xml" data="{% static 'svg/mapa_de_procesosUS.svg' %}" style="width: 85%; height: auto; border: none;"></object>
    </div>
    <!-- Tutoriales -->
    <div class="container mt-2"></div>
    <h1 class="text-center mb-5" style="font-size: 3.5rem;"><i class="bi bi-play-btn-fill me-2"></i>Tutoriales</h1>
    <div style="display: flex; justify-content: center; align-items: center; width: 100%;">
      <!-- Usuario Consultas -->
      <div class="sidebar pb-4">
        <h4 class="text-center"><i class="bi bi-search me-2"></i>Consultas</h4>
        <div class="accordion" id="tutorialAccordion">
          <!-- Cadena de Valor -->
          <div class="accordion-item bg-transparent">
            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cadenavalorconsultas"><i class="bi bi-diagram-3 me-2"></i>Cadena de Valor</button></h2>
            <div id="cadenavalorconsultas" class="accordion-collapse collapse">
              <div class="accordion-body">
                <ul class="tutorial-list">
                  <li class="tutorial-item">
                    <a href="#" data-video-url="https://youtube.com/embed/oSJgFVkOw1Q">
                      <i class="bi bi-map"></i>
                      Exploración
                    </a>
                  </li>
                  <li class="tutorial-item">
                    <a href="#" data-video-url="https://youtube.com/embed/cXLWuZaKUDo">
                      <i class="bi bi-eye-fill"></i>
                      Ver Proceso
                    </a>
                  </li>
                  <li class="tutorial-item">
                    <a href="#" data-video-url="https://youtube.com/embed/ejemplo3">
                      <i class="bi bi-eye"></i>
                      Ver Procedimiento
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <!-- Documentación -->
          <div class="accordion-item bg-transparent">
            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#documentacionconsultas"><i class="bi bi-file-earmark me-2"></i>Documentación</button></h2>
            <div id="documentacionconsultas" class="accordion-collapse collapse">
              <div class="accordion-body" style="border-bottom-left-radius: 5px; border-bottom-right-radius: 5px;">
                <ul class="tutorial-list">
                  <li class="tutorial-item">
                    <a href="#" data-video-url="https://youtube.com/embed/oSJgFVkOw1Q">
                      <i class="bi bi-list-task"></i>
                      Lista Maestra de Documentos
                    </a>
                  </li>
                  <li class="tutorial-item">
                    <a href="#" data-video-url="https://youtube.com/embed/ejemplo5">
                      <i class="bi bi-journal-bookmark-fill"></i>
                      Manuales
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <!-- Glosario -->
          <div class="accordion-item bg-transparent">
            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#glosarioconsultas"><i class="bi bi-book me-2"></i>Glosario</button></h2>
            <div id="glosarioconsultas" class="accordion-collapse collapse">
              <div class="accordion-body" style="border-bottom-left-radius: 5px; border-bottom-right-radius: 5px;">
                <ul class="tutorial-list">
                  <li class="tutorial-item">
                    <a href="#" data-video-url="https://youtube.com/embed/oSJgFVkOw1Q">
                      <i class="bi bi-search"></i>
                      Busqueda
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% if user.is_authenticated and user.is_superuser %}
        <!-- Usuario Administrativo -->
        <div class="sidebar pb-4">
          <h4 class="text-center"><i class="bi bi-tools me-2"></i>Administrativo</h4>
          <div class="accordion" id="tutorialAccordion">
            <!-- Cadena de Valor -->
            <div class="accordion-item bg-transparent">
              <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cadenavaloradmin"><i class="bi bi-diagram-3 me-2"></i>Cadena de Valor</button></h2>
              <div id="cadenavaloradmin" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <ul class="tutorial-list">
                    <li class="tutorial-item">
                      <a href="#" data-video-url="https://youtube.com/embed/oSJgFVkOw1Q">
                        <i class="bi bi-pen"></i>
                        Editar Proceso
                      </a>
                    </li>
                    <li class="tutorial-item">
                      <a href="#" data-video-url="https://youtube.com/embed/cXLWuZaKUDo">
                        <i class="bi bi-file-earmark-plus"></i>
                        Agregar Procedimiento
                      </a>
                    </li>
                    <li class="tutorial-item">
                      <a href="#" data-video-url="https://youtube.com/embed/ejemplo3">
                        <i class="bi bi-file-earmark-x"></i>
                        Eliminar Procedimiento
                      </a>
                    </li>
                    <li class="tutorial-item">
                      <a href="#" data-video-url="https://youtube.com/embed/ejemplo3">
                        <i class="bi bi-file-earmark-image"></i>
                        Agregar Diagramas
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <!-- Documentación -->
            <div class="accordion-item bg-transparent">
              <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#documentacionadmin"><i class="bi bi-file-earmark me-2"></i>Documentación</button></h2>
              <div id="documentacionadmin" class="accordion-collapse collapse">
                <div class="accordion-body" style="border-bottom-left-radius: 5px; border-bottom-right-radius: 5px;">
                  <ul class="tutorial-list">
                    <li class="tutorial-item">
                      <a href="#" data-video-url="https://youtube.com/embed/oSJgFVkOw1Q">
                        <i class="bi bi-list-task"></i>
                        Lista Maestra de Documentos
                      </a>
                    </li>
                    <li class="tutorial-item">
                      <a href="#" data-video-url="https://youtube.com/embed/ejemplo5">
                        <i class="bi bi-journal-bookmark-fill"></i>
                        Manuales
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <!-- Glosario -->
            <div class="accordion-item bg-transparent">
              <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#glosarioadmin"><i class="bi bi-book me-2"></i>Glosario</button></h2>
              <div id="glosarioadmin" class="accordion-collapse collapse">
                <div class="accordion-body" style="border-bottom-left-radius: 5px; border-bottom-right-radius: 5px;">
                  <ul class="tutorial-list">
                    <li class="tutorial-item">
                      <a href="#" data-video-url="https://youtube.com/embed/oSJgFVkOw1Q">
                        <i class="bi bi-pencil-square"></i>
                        Edicion
                      </a>
                    </li>
                    <li class="tutorial-item">
                      <a href="#" data-video-url="https://youtube.com/embed/oSJgFVkOw1Q">
                        <i class="bi bi-trash"></i>
                        Eliminación
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <!-- Panel Administración -->
            <div class="accordion-item bg-transparent">
              <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#paneladmin"><i class="bi-person-lines-fill me-2"></i>Panel Administración</button></h2>
              <div id="paneladmin" class="accordion-collapse collapse">
                <div class="accordion-body" style="border-bottom-left-radius: 5px; border-bottom-right-radius: 5px;">
                  <ul class="tutorial-list">
                    <li class="tutorial-item">
                      <a href="#" data-video-url="https://youtube.com/embed/oSJgFVkOw1Q">
                        <i class="bi bi-person-plus-fill"></i>
                        Agregar Usuario
                      </a>
                    </li>
                    <li class="tutorial-item">
                      <a href="#" data-video-url="https://youtube.com/embed/ejemplo5">
                        <i class="bi bi-pencil-square"></i>
                        Editar Usuario
                      </a>
                    </li>
                    <li class="tutorial-item">
                      <a href="#" data-video-url="https://youtube.com/embed/cXLWuZaKUDo">
                        <i class="bi bi-person-x-fill"></i>
                        Eliminar Usuario
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Video Modal -->
    <div id="videoModal" class="modal-video-overlay">
      <div class="modal-video-container">
        <button id="closeVideoModal" class="modal-video-close">&times;</button>
        <div class="modal-video-wrapper">
          <iframe id="tutorialVideoFrame" src="" frameborder="0" allowfullscreen data-cookieconsent="ignore"></iframe>
        </div>
      </div>
    </div>
    <!-- Ultimas novedades -->
    <section class="container mt-5 mb-5">
      <h1 class="mb-5 text-center" style="font-size: 3.5rem;"><i class="bi bi-megaphone-fill me-2"></i>Últimas Novedades</h1>
      <div class="row row-cols-1 row-cols-md-3 g-4" id="novedades">
        {% if ultimos_archivos %}
          {% for item in ultimos_archivos %}
            <div class="col">
              <div class="card animate shadow-hover transform-hover">
                <div class="card-body d-flex flex-column">
                  <h6 class="card-title text-center mb-3 fw-bold">
                    {% if item.titulo %}
                      {{ item.titulo }}
                    {% elif item.title %}
                      {{ item.title }}
                    {% endif %}
                  </h6>
                  <p class="card-text small text-center text-muted mb-4">
                    <strong>Fecha:</strong> {{ item.fecha_creacion|date:'d F Y' }}<br />
                    <strong>Hora:</strong> {{ item.fecha_creacion|localtime|date:'h:i A' }}
                  </p>

                  <div class="mt-auto text-center">
                    {% if item.id_archivo %}
                      <a href="{% url 'ver_pdf_solo' item.id_archivo %}" class="btn btn-ver btn-sm rounded-pill px-3 text-decoration-none">Ver Documento</a>
                    {% elif item.id %}
                      <a href="{% url 'ver_pdf_solo_formatos' item.id %}" class="btn btn-ver btn-sm rounded-pill px-3 text-decoration-none">Ver Formato</a>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="col-12">
            <p class="text-center text-muted">No hay archivos disponibles.</p>
          </div>
        {% endif %}
      </div>
    </section>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    window.USER_NAME = '{{ user.first_name }} {{ user.last_name }}'
    
    // Forzar recarga total con el servidor
    window.onload = function () {
      // Asegurarse que carga la interactividad del mapa de procesos haciendo un hard refresh
      if (!window.location.href.includes('refreshed=true')) {
        window.location.href = window.location.href + (window.location.href.includes('?') ? '&' : '?') + 'refreshed=true'
      }
    }
  </script>
  <script src="{% static 'js/interactiveSvgMap.js' %}"></script>
  <script src="{% static 'js/mapaProcesos.js' %}"></script>
{% endblock %}
